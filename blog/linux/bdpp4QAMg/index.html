<!doctype html><html lang=zh dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ç®€å•çš„è®²è®²nginx+phpçš„ä¸€äº›å¸¸ç”¨ä¼˜åŒ–ï¼Œä»¥åŠç›¸å…³çš„å†…æ ¸å‚æ•°ä¼˜åŒ–ã€‚ Nginx ä¼˜åŒ– # 1. TCP ä¸ UNIX å¥—æ¥å­— UNIX åŸŸå¥—æ¥å­—æä¾›çš„æ€§èƒ½ç•¥é«˜äº TCP å¥—æ¥å­—åœ¨å›é€æ¥å£ä¸Šçš„æ€§"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="nginxåŠphp-fpmä¼˜åŒ–"><meta property="og:description" content="ç®€å•çš„è®²è®²nginx+phpçš„ä¸€äº›å¸¸ç”¨ä¼˜åŒ–ï¼Œä»¥åŠç›¸å…³çš„å†…æ ¸å‚æ•°ä¼˜åŒ–ã€‚ Nginx ä¼˜åŒ– # 1. TCP ä¸ UNIX å¥—æ¥å­— UNIX åŸŸå¥—æ¥å­—æä¾›çš„æ€§èƒ½ç•¥é«˜äº TCP å¥—æ¥å­—åœ¨å›é€æ¥å£ä¸Šçš„æ€§"><meta property="og:type" content="article"><meta property="og:url" content="https://notes.zhangwenbing.com/blog/linux/bdpp4QAMg/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-04T16:33:34+08:00"><meta property="article:modified_time" content="2020-12-04T16:33:34+08:00"><title>nginxåŠphp-fpmä¼˜åŒ– | å¼ æ–‡å…µçš„ç¬”è®°</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=canonical href=https://notes.zhangwenbing.com/blog/linux/bdpp4QAMg/><link rel=stylesheet href=/book.min.9cbac6011862cde1818a9dbcef04258264fd44c1d5ec11d1aca0fa3b6f7942dd.css integrity="sha256-nLrGARhizeGBip287wQlgmT9RMHV7BHRrKD6O295Qt0=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/zh.search.min.0ccc9c790cdb755bda8f6c879129bceb254121d9012125854ddb98c5c3975b14.js integrity="sha256-DMyceQzbdVvaj2yHkSm86yVBIdkBISWFTduYxcOXWxQ=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>å¼ æ–‡å…µçš„ç¬”è®°</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=æœç´¢ aria-label=æœç´¢ maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-6d1804e163fb7f5fbc576b94719a59cb class=toggle>
<label for=section-6d1804e163fb7f5fbc576b94719a59cb class="flex justify-between"><a role=button>ğŸ‘¨ğŸ¼â€ğŸ’» ç¼–ç¨‹ç›¸å…³</a></label><ul><li><input type=checkbox id=section-0aec292f8bca227859512cec8a349fde class=toggle>
<label for=section-0aec292f8bca227859512cec8a349fde class="flex justify-between"><a role=button>ğŸ“” Rust</a></label><ul><li><input type=checkbox id=section-2c4b9a1cbc74613570f3c4585f635628 class=toggle>
<label for=section-2c4b9a1cbc74613570f3c4585f635628 class="flex justify-between"><a role=button>ğŸ”– å­¦ä¹ ç¬”è®°</a></label><ul><li><a href=/notes/2024/03/06/e3ksq3zkmps14gcxuirwzx/>ğŸ“ æ‰€æœ‰æƒ</a></li><li><a href=/notes/2024/03/06/o4arkqgfnqygr5ckif2gkk/>ğŸ“ å€Ÿç”¨ä¸å¼•ç”¨</a></li></ul></li></ul></li><li><input type=checkbox id=section-e9c99308492d6ec7c6ad1055f21a8388 class=toggle>
<label for=section-e9c99308492d6ec7c6ad1055f21a8388 class="flex justify-between"><a role=button>ğŸ“” C++</a></label><ul><li><a href=/notes/2024/06/06/sf4ff6x8cuyhvzougj9dwg/>ğŸ“ MacOSç­¾å</a></li><li><a href=/notes/2024/05/28/3txbbb7iruppjsg4p7rwnb/>ğŸ“ MacOSå †æ ˆå¤§å°</a></li></ul></li><li><input type=checkbox id=section-aea9addc7ea0cf58a2c2c9ec52f959c9 class=toggle>
<label for=section-aea9addc7ea0cf58a2c2c9ec52f959c9 class="flex justify-between"><a role=button>ğŸ“” Git</a></label><ul><li><a href=/notes/2024/03/11/j3c62fv8dglvf2kg975zlv/>ğŸ“ æ ‡ç­¾æ“ä½œ</a></li><li><a href=/notes/2024/03/14/5kqlzqjqawbxf2t6vusxar/>ğŸ“ åˆ é™¤Commit</a></li><li><a href=/blog/git/WNYzxj6GR/>ğŸ“ gitä¹‹åˆ é™¤è¿œç¨‹åˆ†æ”¯</a></li><li><a href=/blog/git/-fZeBsu3T/>ğŸ“ gitæ›´æ–°.gitignore</a></li><li><a href=/blog/git/H1Krv6b-4/>ğŸ“ gitä¿®æ”¹å†å²cimmitä¿¡æ¯</a></li><li><a href=/blog/git/By9OI51xN/>ğŸ“ gitåŸºç¡€ç¬”è®°</a></li><li><a href=/blog/git/Hk6GGp6cQ/>ğŸ“ Gitå›æ»šåˆ°æŸä¸ªcommit</a></li></ul></li></ul></li><li><a href=/links/>ğŸ¤ å‹æƒ…é“¾æ¥</a></li></ul><ul><li><a href=/articles/>ğŸ“š æˆ‘çš„æ–‡ç« </a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>nginxåŠphp-fpmä¼˜åŒ–</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#nginx-ä¼˜åŒ–>Nginx ä¼˜åŒ–</a></li><li><a href=#php-fpm-ä¼˜åŒ–>PHP-fpm ä¼˜åŒ–</a></li><li><a href=#å†…æ ¸ä¼˜åŒ–>å†…æ ¸ä¼˜åŒ–</a><ul><li><a href=#ä¸€-time_waitäº§ç”ŸåŸå› >ä¸€ TIME_WAITäº§ç”ŸåŸå› ï¼š</a></li><li><a href=#äºŒ-è¿‡å¤štime_waitå±å®³>äºŒ è¿‡å¤šTIME_WAITå±å®³</a></li><li><a href=#ä¸‰-è§£å†³æ–¹æ³•>ä¸‰ è§£å†³æ–¹æ³•</a></li></ul></li></ul></nav></aside></header><article class="markdown book-post"><h1 class=book-post-title><a href=/blog/linux/bdpp4QAMg/>nginxåŠphp-fpmä¼˜åŒ–</a></h1><div class=book-post-meta><span class=book-post-meta-date>2020-12-04</span>
<span class=book-post-meta-separator-categories>&nbsp; | &nbsp;</span>
<span class=book-post-meta-categories><a href=/categories/linux/>Linux</a>
</span><span class=book-post-meta-separator-tags>&nbsp; | &nbsp;</span>
<span class=book-post-meta-tags><a href=/tags/linux/>Linux</a></span></div><blockquote><p>ç®€å•çš„è®²è®²nginx+phpçš„ä¸€äº›å¸¸ç”¨ä¼˜åŒ–ï¼Œä»¥åŠç›¸å…³çš„å†…æ ¸å‚æ•°ä¼˜åŒ–ã€‚</p></blockquote><h2 id=nginx-ä¼˜åŒ–>Nginx ä¼˜åŒ–
<a class=anchor href=#nginx-%e4%bc%98%e5%8c%96>#</a></h2><p><strong>1. TCP ä¸ UNIX å¥—æ¥å­—</strong></p><p>UNIX åŸŸå¥—æ¥å­—æä¾›çš„æ€§èƒ½ç•¥é«˜äº TCP å¥—æ¥å­—åœ¨å›é€æ¥å£ä¸Šçš„æ€§èƒ½ï¼ˆè¾ƒå°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¾ƒå°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ã€‚å¦‚æœæ¯ä¸ªæœåŠ¡å™¨éœ€è¦æ”¯æŒè¶…è¿‡ 1000 ä¸ªè¿æ¥ï¼Œè¯·ä½¿ç”¨ TCP å¥—æ¥å­— - å®ƒä»¬å¯ä»¥æ›´å¥½åœ°æ‰©å±•ã€‚</p><pre tabindex=0><code>upstream backend
{
  server unix:/var/run/fastcgi.sock;
}
</code></pre><p><strong>2. è°ƒæ•´ worker_processes å‚æ•°</strong></p><p>ç°ä»£ç¡¬ä»¶æ˜¯å¤šå¤„ç†å™¨ï¼ŒNGINX å¯ä»¥åˆ©ç”¨å¤šä¸ªç‰©ç†æˆ–è™šæ‹Ÿå¤„ç†å™¨ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨çš„ Web æœåŠ¡å™¨è®¡ç®—æœºä¸ä¼šé…ç½®ä¸ºå¤„ç†å¤šä¸ªå·¥ä½œè´Ÿè½½ï¼ˆä¾‹å¦‚åŒæ—¶æä¾› Web æœåŠ¡å™¨å’Œæ‰“å°æœåŠ¡å™¨çš„æœåŠ¡ï¼‰ï¼Œå› æ­¤æ‚¨éœ€è¦é…ç½® NGINX ä»¥ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨ï¼Œå› ä¸º NGINX å·¥ä½œè¿›ç¨‹æ˜¯ä¸æ˜¯å¤šçº¿ç¨‹çš„ã€‚</p><p>å°† nginx.conf æ–‡ä»¶ä¸­çš„ worker_processes è®¾ç½®ä¸ºè®¡ç®—æœºæ‰€å…·æœ‰çš„æ ¸å¿ƒæ•°ã€‚</p><p>å½“ä½ åœ¨å®ƒçš„æ—¶å€™ï¼Œå¢åŠ  worker_connections çš„æ•°é‡ï¼ˆæ¯ä¸ªæ ¸å¿ƒåº”è¯¥å¤„ç†å¤šå°‘ä¸ªè¿æ¥ï¼‰å¹¶å°† multi_accept è®¾ç½®ä¸º ONï¼Œå¦‚æœä½ åœ¨ Linux ä¸Šåˆ™è®¾ç½®ä¸º epollï¼š</p><pre tabindex=0><code>worker_processes 4;
events
{
  worker_connections 1024;
  multi_accept on;
}
</code></pre><p><strong>3. ç¦ç”¨è®¿é—®æ—¥å¿—</strong></p><pre tabindex=0><code>access_log off;
log_not_found off;
error_log /var/log/nginx-error.log warn;
</code></pre><p>å¦‚æœæœ‰éœ€è¦ä¸å¯ä»¥å…³é—­ï¼Œè‡³å°‘æ˜¯ç¼“å­˜ä»–ä»¬</p><pre tabindex=0><code>access_log /var/log/nginx/access.log main buffer=16k;
</code></pre><p><strong>4. å¼€å¯ gzip å‹ç¼©</strong></p><pre tabindex=0><code>gzip on;
gzip_disable &#34;msie6&#34;;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1100;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
</code></pre><p><strong>5. ç¼“å­˜è®¿é—®é¢‘æ¬¡è¾ƒé«˜çš„æ–‡ä»¶</strong></p><pre tabindex=0><code>open_file_cache max=2000 inactive=20s;
open_file_cache_valid 60s;
open_file_cache_min_uses 5;
open_file_cache_errors off;
</code></pre><p><strong>6. è°ƒæ•´å®¢æˆ·ç«¯è¶…æ—¶</strong></p><pre tabindex=0><code>client_max_body_size 50M;
client_body_buffer_size 1m;
client_body_timeout 15;
client_header_timeout 15;
keepalive_timeout 2 2;
send_timeout 15;
sendfile on;
tcp_nopush on;
tcp_nodelay on;
</code></pre><p><strong>7. è°ƒæ•´è¾“å‡ºç¼“å­˜</strong></p><pre tabindex=0><code>fastcgi_buffers 256 16k;
fastcgi_buffer_size 128k;
fastcgi_connect_timeout 3s;
fastcgi_send_timeout 120s;
fastcgi_read_timeout 120s;
fastcgi_busy_buffers_size 256k;
fastcgi_temp_file_write_size 256k;
reset_timedout_connection on;
server_names_hash_bucket_size 100;
</code></pre><p><strong>8. è´Ÿè½½å‡è¡¡ç­–ç•¥</strong></p><p>Nginx æä¾›è½®è¯¢ï¼ˆround robinï¼‰ã€ç”¨æˆ· IP å“ˆå¸Œï¼ˆclient IPï¼‰å’ŒæŒ‡å®šæƒé‡ 3 ç§æ–¹å¼ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šä¸ºä½ æä¾›è½®è¯¢ä½œä¸ºè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚ä½†æ˜¯è¿™å¹¶ä¸ä¸€å®šèƒ½å¤Ÿè®©ä½ æ»¡æ„ã€‚æ¯”å¦‚ï¼ŒæŸä¸€æ—¶æ®µå†…çš„ä¸€è¿ä¸²è®¿é—®éƒ½æ˜¯ç”±åŒä¸€ä¸ªç”¨æˆ· Michael å‘èµ·çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡ Michael çš„è¯·æ±‚å¯èƒ½æ˜¯ backend2ï¼Œè€Œä¸‹ä¸€æ¬¡æ˜¯ backend3ï¼Œç„¶åæ˜¯ backend1ã€backend2ã€backend3â€¦â€¦ åœ¨å¤§å¤šæ•°åº”ç”¨åœºæ™¯ä¸­ï¼Œè¿™æ ·å¹¶ä¸é«˜æ•ˆã€‚å½“ç„¶ï¼Œä¹Ÿæ­£å› å¦‚æ­¤ï¼ŒNginx ä¸ºä½ æä¾›äº†ä¸€ä¸ªæŒ‰ç…§ Michaelã€Jasonã€David ç­‰ç­‰è¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„ç”¨æˆ·çš„ IP æ¥ hash çš„æ–¹å¼ï¼Œè¿™æ ·æ¯ä¸ª client çš„è®¿é—®è¯·æ±‚éƒ½ä¼šè¢«ç”©ç»™åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ã€‚</p><pre tabindex=0><code>upstream backend {
  ip_hash;
  server unix:/var/run/php7.2-fpm.sock1 weight=100 max_fails=5 fail_timeout=5;
  server unix:/var/run/php7.2-fpm.sock2 weight=100 max_fails=5 fail_timeout=5;
}
</code></pre><p><strong>9. æŒç»­ç›‘æ§æ—¥å¿—</strong></p><p>å°¤å…¶æ˜¯åœ¨è°ƒä¼˜æœ€åˆæœŸï¼Œåœ¨ä¸€ä¸ªçª—å£</p><pre tabindex=0><code>tail -f /var/log/nginx/error.log
</code></pre><p>åœ¨å¦å¤–ä¸¤ä¸ªçª—å£åˆ†åˆ«ï¼š</p><pre tabindex=0><code>tail -f /var/log/php-fpm/error.log
tail -f /var/log/php-fpm/www-error.log
</code></pre><h2 id=php-fpm-ä¼˜åŒ–>PHP-fpm ä¼˜åŒ–
<a class=anchor href=#php-fpm-%e4%bc%98%e5%8c%96>#</a></h2><p><strong>1. ä¿®æ”¹è¿›ç¨‹ç®¡ç†æ¨¡å¼</strong></p><p>static ç®¡ç†æ¨¡å¼é€‚åˆæ¯”è¾ƒå¤§å†…å­˜çš„æœåŠ¡å™¨ï¼Œè€Œ dynamic åˆ™é€‚åˆå°å†…å­˜çš„æœåŠ¡å™¨ï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ª pm.min_spare_servers å’Œ pm.max_spare_servers åˆç†èŒƒå›´ï¼Œè¿™æ ·è¿›ç¨‹æ•°ä¼šä¸æ–­å˜åŠ¨ã€‚ondemand æ¨¡å¼åˆ™æ›´åŠ é€‚åˆå¾®å°å†…å­˜ï¼Œä¾‹å¦‚ 512MB æˆ–è€… 256MB å†…å­˜ï¼Œä»¥åŠå¯¹å¯ç”¨æ€§è¦æ±‚ä¸é«˜çš„ç¯å¢ƒã€‚</p><pre tabindex=0><code>pm = dynamic #æŒ‡å®šè¿›ç¨‹ç®¡ç†æ–¹å¼ï¼Œæœ‰3ç§å¯ä¾›é€‰æ‹©ï¼šstaticã€dynamicå’Œondemandã€‚
pm.max_children = 16 #staticæ¨¡å¼ä¸‹åˆ›å»ºçš„å­è¿›ç¨‹æ•°æˆ–dynamicæ¨¡å¼ä¸‹åŒä¸€æ—¶åˆ»å…è®¸æœ€å¤§çš„php-fpmå­è¿›ç¨‹æ•°é‡ã€‚
pm.start_servers = 10 #åŠ¨æ€æ–¹å¼ä¸‹çš„èµ·å§‹php-fpmè¿›ç¨‹æ•°é‡ã€‚
pm.min_spare_servers = 8 #åŠ¨æ€æ–¹å¼ä¸‹æœåŠ¡å™¨ç©ºé—²æ—¶æœ€å°php-fpmè¿›ç¨‹æ•°é‡ã€‚
pm.max_spare_servers = 16 #åŠ¨æ€æ–¹å¼ä¸‹æœåŠ¡å™¨ç©ºé—²æ—¶æœ€å¤§php-fpmè¿›ç¨‹æ•°é‡ã€‚
pm.max_requests = 2000 #php-fpmå­è¿›ç¨‹èƒ½å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ã€‚
pm.process_idle_timeout = 10s
request_terminate_timeout = 120
</code></pre><p>pm = staticï¼Œå§‹ç»ˆä¿æŒä¸€ä¸ªå›ºå®šæ•°é‡çš„å­è¿›ç¨‹ï¼Œè¿™ä¸ªæ•°ç”± pm.max_children å®šä¹‰ï¼Œè¿™ç§æ–¹å¼å¾ˆä¸çµæ´»ï¼Œä¹Ÿé€šå¸¸ä¸æ˜¯é»˜è®¤çš„ã€‚</p><p>pm = dynamicï¼Œå¯åŠ¨æ—¶ä¼šäº§ç”Ÿå›ºå®šæ•°é‡çš„å­è¿›ç¨‹ï¼ˆç”± pm.start_servers æ§åˆ¶ï¼‰å¯ä»¥ç†è§£æˆæœ€å°å­è¿›ç¨‹æ•°ï¼Œè€Œæœ€å¤§å­è¿›ç¨‹æ•°åˆ™ç”± pm.max_children å»æ§åˆ¶ï¼Œå­è¿›ç¨‹æ•°ä¼šåœ¨æœ€å¤§å’Œæœ€å°æ•°èŒƒå›´ä¸­å˜åŒ–ã€‚é—²ç½®çš„å­è¿›ç¨‹æ•°è¿˜å¯ä»¥ç”±å¦ 2 ä¸ªé…ç½®æ§åˆ¶ï¼Œåˆ†åˆ«æ˜¯ pm.min_spare_servers å’Œ pm.max_spare_serversã€‚å¦‚æœé—²ç½®çš„å­è¿›ç¨‹è¶…å‡ºäº† pm.max_spare_serversï¼Œåˆ™ä¼šè¢«æ€æ‰ã€‚å°äº pm.min_spare_servers åˆ™ä¼šå¯åŠ¨è¿›ç¨‹ï¼ˆæ³¨æ„ï¼Œpm.max_spare_servers åº”å°äº pm.max_childrenï¼‰ã€‚</p><p>pm = ondemandï¼Œè¿™ç§æ¨¡å¼å’Œ pm = dynamic ç›¸åï¼ŒæŠŠå†…å­˜æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œæ¯ä¸ªé—²ç½®è¿›ç¨‹åœ¨æŒç»­é—²ç½®äº† pm.process_idle_timeout ç§’åå°±ä¼šè¢«æ€æ‰ï¼Œå¦‚æœæœåŠ¡å™¨é•¿æ—¶é—´æ²¡æœ‰è¯·æ±‚ï¼Œå°±åªä¼šæœ‰ä¸€ä¸ª php-fpm ä¸»è¿›ç¨‹ã€‚å¼Šç«¯æ˜¯é‡åˆ°é«˜å³°æœŸæˆ–è€…å¦‚æœ pm.process_idle_timeout çš„å€¼å¤ªçŸ­çš„è¯ï¼Œå®¹æ˜“å‡ºç° 504 Gateway Time-out é”™è¯¯ï¼Œå› æ­¤ pm = dynamic å’Œ pm = ondemand è°æ›´é€‚åˆè§†å®é™…æƒ…å†µè€Œå®šã€‚</p><p><strong>2. é‡Šæ”¾å†…å­˜çš„é…ç½®</strong></p><pre tabindex=0><code>pm.max_requests = 1000
</code></pre><p>è®¾ç½®æ¯ä¸ªå­è¿›ç¨‹é‡ç”Ÿä¹‹å‰æœåŠ¡çš„è¯·æ±‚æ•°. å¯¹äºå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„ç¬¬ä¸‰æ–¹æ¨¡å—æ¥è¯´æ˜¯éå¸¸æœ‰ç”¨çš„. å¦‚æœè®¾ç½®ä¸º â€˜0â€™ åˆ™ä¸€ç›´æ¥å—è¯·æ±‚. ç­‰åŒäº PHP_FCGI_MAX_REQUESTS ç¯å¢ƒå˜é‡. é»˜è®¤å€¼: 0.</p><p>ä¹Ÿå°±æ˜¯å½“ä¸€ä¸ª PHP-CGI è¿›ç¨‹å¤„ç†çš„è¯·æ±‚æ•°ç´¯ç§¯åˆ° 1000 ä¸ªåï¼Œè‡ªåŠ¨é‡å¯è¯¥è¿›ç¨‹ï¼Œé˜²æ­¢ç¬¬ä¸‰æ–¹åº“é€ æˆçš„å†…å­˜æ³„æ¼ã€‚ é‡å¯æ—¶å¯èƒ½ä¼šå¯¼è‡´ 502 é”™è¯¯ï¼Œåœ¨é«˜å¹¶å‘ç«™ç‚¹æ—¶æœ‰å‡ºç°ã€‚</p><p><strong>3. php-fpm æ…¢æ—¥å¿—</strong></p><pre tabindex=0><code>request_terminate_timeout = 30s #å°†æ‰§è¡Œæ—¶é—´å¤ªé•¿çš„è¿›ç¨‹ç›´æ¥ç»ˆæ­¢
request_slowlog_timeout = 2s #2ç§’
slowlog = log/$pool.log.slow #æ—¥å¿—æ–‡ä»¶
</code></pre><h2 id=å†…æ ¸ä¼˜åŒ–>å†…æ ¸ä¼˜åŒ–
<a class=anchor href=#%e5%86%85%e6%a0%b8%e4%bc%98%e5%8c%96>#</a></h2><h3 id=ä¸€-time_waitäº§ç”ŸåŸå› >ä¸€ TIME_WAITäº§ç”ŸåŸå› ï¼š
<a class=anchor href=#%e4%b8%80-time_wait%e4%ba%a7%e7%94%9f%e5%8e%9f%e5%9b%a0>#</a></h3><p>1ã€nginxç°æœ‰çš„è´Ÿè½½å‡è¡¡æ¨¡å—å®ç°php fastcgiè´Ÿè½½å‡è¡¡ï¼Œnginxä½¿ç”¨äº†çŸ­è¿æ¥æ–¹å¼ï¼Œæ‰€ä»¥ä¼šé€ æˆå¤§é‡å¤„äºTIME_WAITçŠ¶æ€çš„è¿æ¥ã€‚</p><p>2ã€TCP/IPè®¾è®¡è€…æœ¬æ¥æ˜¯è¿™ä¹ˆè®¾è®¡çš„</p><p>ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› </p><p>(1) é˜²æ­¢ä¸Šä¸€æ¬¡è¿æ¥ä¸­çš„åŒ…ï¼Œè¿·è·¯åé‡æ–°å‡ºç°ï¼Œå½±å“æ–°è¿æ¥ï¼ˆç»è¿‡2MSLï¼Œä¸Šä¸€æ¬¡è¿æ¥ä¸­æ‰€æœ‰çš„é‡å¤åŒ…éƒ½ä¼šæ¶ˆå¤±ï¼‰</p><p>(2) å¯é çš„å…³é—­TCPè¿æ¥</p><p>åœ¨ä¸»åŠ¨å…³é—­æ–¹å‘é€çš„æœ€åä¸€ä¸ª ack(fin) ï¼Œæœ‰å¯èƒ½ä¸¢å¤±ï¼Œè¿™æ—¶è¢«åŠ¨æ–¹ä¼šé‡æ–°å‘fin, å¦‚æœè¿™æ—¶ä¸»åŠ¨æ–¹å¤„äº CLOSED çŠ¶æ€ ï¼Œå°±ä¼šå“åº” rst è€Œä¸æ˜¯ ackã€‚æ‰€ä»¥ä¸»åŠ¨æ–¹è¦å¤„äº TIME_WAIT çŠ¶æ€ï¼Œè€Œä¸èƒ½æ˜¯ CLOSED ã€‚</p><h3 id=äºŒ-è¿‡å¤štime_waitå±å®³>äºŒ è¿‡å¤šTIME_WAITå±å®³
<a class=anchor href=#%e4%ba%8c-%e8%bf%87%e5%a4%9atime_wait%e5%8d%b1%e5%ae%b3>#</a></h3><p>TIME_WAIT å¹¶ä¸ä¼šå ç”¨å¾ˆå¤§èµ„æºçš„ï¼Œé™¤éå—åˆ°æ”»å‡»ã€‚åªè¦æŠŠTIME_WAITæ‰€å ç”¨å†…å­˜æ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ã€‚ä¸€èˆ¬é»˜è®¤æœ€å¤§æ˜¯35600æ¡TIME_WAITã€‚</p><h3 id=ä¸‰-è§£å†³æ–¹æ³•>ä¸‰ è§£å†³æ–¹æ³•
<a class=anchor href=#%e4%b8%89-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95>#</a></h3><p>net.ipv4.tcp_syncookies = 1 è¡¨ç¤ºå¼€å¯SYN Cookiesã€‚å½“å‡ºç°SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨cookiesæ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡SYNæ”»å‡»ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚</p><p>net.ipv4.tcp_tw_reuse = 1 è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚</p><p>net.ipv4.tcp_tw_recycle = 1 è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚</p><p>net.ipv4.tcp_fin_timeout = 30 è¡¨ç¤ºå¦‚æœå¥—æ¥å­—ç”±æœ¬ç«¯è¦æ±‚å…³é—­ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†å®ƒä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ã€‚</p><p>net.ipv4.tcp_keepalive_time = 1200 è¡¨ç¤ºå½“keepaliveèµ·ç”¨çš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯2å°æ—¶ï¼Œæ”¹ä¸º20åˆ†é’Ÿã€‚</p><p>net.ipv4.ip_local_port_range = 1024 65000 è¡¨ç¤ºç”¨äºå‘å¤–è¿æ¥çš„ç«¯å£èŒƒå›´ã€‚ç¼ºçœæƒ…å†µä¸‹å¾ˆå°ï¼š32768åˆ°61000ï¼Œæ”¹ä¸º1024åˆ°65000ã€‚</p><p>net.ipv4.tcp_max_syn_backlog = 8192 è¡¨ç¤ºSYNé˜Ÿåˆ—çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º1024ï¼ŒåŠ å¤§é˜Ÿåˆ—é•¿åº¦ä¸º8192ï¼Œå¯ä»¥å®¹çº³æ›´å¤šç­‰å¾…è¿æ¥çš„ç½‘ç»œè¿æ¥æ•°ã€‚</p><p>net.ipv4.tcp_max_tw_buckets = 5000 è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒTIME_WAITå¥—æ¥å­—çš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå¥—æ¥å­—å°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚é»˜ è®¤ä¸º180000ï¼Œæ”¹ä¸º5000ã€‚å¯¹äºApacheã€Nginxç­‰æœåŠ¡å™¨ï¼Œä¸Šå‡ è¡Œçš„å‚æ•°å¯ä»¥å¾ˆå¥½åœ°å‡å°‘TIME_WAITå¥—æ¥å­—æ•°é‡ï¼Œä½†æ˜¯å¯¹äºSquidï¼Œæ•ˆæœå´ä¸å¤§ã€‚æ­¤é¡¹å‚æ•°å¯ä»¥æ§åˆ¶TIME_WAITå¥—æ¥å­—çš„æœ€å¤§æ•°é‡ï¼Œé¿å…SquidæœåŠ¡å™¨è¢«å¤§é‡çš„TIME_WAITå¥—æ¥å­—æ‹–æ­»ã€‚</p><p>æ³¨:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>net.ipv4.tcp_tw_reuse</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>net.ipv4.tcp_tw_recycle</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1</span>
</span></span></code></pre></div><p>è®¾ç½®è¿™ä¸¤ä¸ªå‚æ•°ï¼š reuseæ˜¯è¡¨ç¤ºæ˜¯å¦å…è®¸é‡æ–°åº”ç”¨å¤„äºTIME-WAITçŠ¶æ€çš„socketç”¨äºæ–°çš„TCPè¿æ¥ï¼› recyseæ˜¯åŠ é€ŸTIME-WAIT socketså›æ”¶</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#nginx-ä¼˜åŒ–>Nginx ä¼˜åŒ–</a></li><li><a href=#php-fpm-ä¼˜åŒ–>PHP-fpm ä¼˜åŒ–</a></li><li><a href=#å†…æ ¸ä¼˜åŒ–>å†…æ ¸ä¼˜åŒ–</a><ul><li><a href=#ä¸€-time_waitäº§ç”ŸåŸå› >ä¸€ TIME_WAITäº§ç”ŸåŸå› ï¼š</a></li><li><a href=#äºŒ-è¿‡å¤štime_waitå±å®³>äºŒ è¿‡å¤šTIME_WAITå±å®³</a></li><li><a href=#ä¸‰-è§£å†³æ–¹æ³•>ä¸‰ è§£å†³æ–¹æ³•</a></li></ul></li></ul></nav></div></aside></main><footer class=index-footer><p><a href=http://beian.miit.gov.cn/>æ¹˜ICPå¤‡2020021630å·</a>
<span>|</span>
<span>&COPY;2024</span></p><p><span id=htmer_time>è½½å…¥ä¸­...</span>
<script>function secondToDate(e){if(!e)return 0;var t=new Array(0,0,0,0,0);return e>=365*24*3600&&(t[0]=parseInt(e/(365*24*3600)),e%=365*24*3600),e>=24*3600&&(t[1]=parseInt(e/(24*3600)),e%=24*3600),e>=3600&&(t[2]=parseInt(e/3600),e%=3600),e>=60&&(t[3]=parseInt(e/60),e%=60),e>0&&(t[4]=e),t}</script><script type=text/javascript language=javascript>function setTime(){var e=Math.round(new Date(Date.UTC(2016,11,1,0,0,0)).getTime()/1e3),t=Math.round(((new Date).getTime()+8*60*60*1e3)/1e3);currentTime=secondToDate(t-e),currentTimeHtml=currentTime[0]+"å¹´"+currentTime[1]+"å¤©"+currentTime[2]+"æ—¶"+currentTime[3]+"åˆ†"+currentTime[4]+"ç§’",document.getElementById("htmer_time").innerHTML="ç¨³å®šè¿è¡Œ:"+currentTimeHtml}setInterval(setTime,1e3)</script></p></footer></body></html>